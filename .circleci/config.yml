version: 2.1

orbs:
  ruby: circleci/ruby@2.1.0

jobs:
  test:
    docker:
      - image: cimg/ruby:3.0-node
        environment:
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
          RAILS_ENV: test
    steps:
      - checkout
      - run:
          name: Configure Bundler
          command: |
            bundle config set --local path vendor/bundle
            bundle config unset deployment
      - run:
          name: Install dependencies
          command: bundle install --jobs=4 --retry=3
      - run:
          name: Run tests
          command: |
            mkdir /tmp/test-results
            bundle exec rspec \
              --format progress \
              --format RspecJunitFormatter \
              --out /tmp/test-results/rspec.xml \
              --format progress
      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          path: /tmp/test-results
          destination: test-results

  lint:
    docker:
      - image: cimg/ruby:3.0
        environment:
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
    steps:
      - checkout
      - run:
          name: Configure Bundler
          command: |
            bundle config set --local path vendor/bundle
            bundle config unset deployment
      - run:
          name: Install dependencies
          command: bundle install --jobs=4 --retry=3
      - run:
          name: Run RuboCop
          command: bundle exec rubocop --config ruby.yml --format progress --format junit --out /tmp/rubocop-results.xml
      - store_test_results:
          path: /tmp/rubocop-results.xml
      - store_artifacts:
          path: /tmp/rubocop-results.xml

  security:
    docker:
      - image: cimg/ruby:3.0-node
        environment:
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
    steps:
      - checkout
      - run:
          name: Configure Bundler
          command: |
            bundle config set --local path vendor/bundle
            bundle config unset deployment
      - run:
          name: Install dependencies
          command: bundle install --jobs=4 --retry=3
      - run:
          name: Install Snyk CLI
          command: |
            curl -Lo snyk https://github.com/snyk/cli/releases/latest/download/snyk-linux
            chmod +x snyk
            sudo mv snyk /usr/local/bin/
      - run:
          name: Authenticate with Snyk
          command: snyk auth $SNYK_TOKEN
      - run:
          name: Run Snyk Security Scan
          command: |
            snyk test --severity-threshold=high --file=Gemfile.lock
      - run:
          name: Monitor project on Snyk
          command: |
            snyk monitor --project-name=${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}
          when: on_success

  build_gem:
    docker:
      - image: cimg/ruby:3.0
        environment:
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
    steps:
      - checkout
      - run:
          name: Configure Bundler
          command: |
            bundle config set --local path vendor/bundle
            bundle config unset deployment
      - run:
          name: Install dependencies
          command: bundle install --jobs=4 --retry=3
      - run:
          name: Build gem
          command: |
            gem build teams_api.gemspec
            mkdir -p /tmp/gems
            mv *.gem /tmp/gems/
            ls -la /tmp/gems/
      - store_artifacts:
          path: /tmp/gems
          destination: gems
      - run:
          name: Display gem info
          command: |
            echo "‚úÖ Gem built successfully!"
            echo "üì¶ Gem file: $(ls /tmp/gems/*.gem)"
            echo "üè∑Ô∏è  Version: $(gem specification /tmp/gems/*.gem version)"
            echo "üìÑ Description: $(gem specification /tmp/gems/*.gem description)"

workflows:
  version: 2
  test_lint_build:
    jobs:
      - test
      - lint
      - security
      - build_gem:
          requires:
            - test
            - lint
            - security
