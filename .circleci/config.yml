version: 2.1

orbs:
  ruby: circleci/ruby@2.1.0

jobs:
  test:
    docker:
      - image: cimg/ruby:3.0-node
    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: Run tests
          command: |
            mkdir /tmp/test-results
            bundle exec rspec \
              --format progress \
              --format RspecJunitFormatter \
              --out /tmp/test-results/rspec.xml
      - store_test_results:
          path: /tmp/test-results

  lint:
    docker:
      - image: cimg/ruby:3.0
    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: Run RuboCop
          command: bundle exec rubocop --config ruby.yml

  build_gem:
    docker:
      - image: cimg/ruby:3.0
    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: Build gem
          command: |
            gem build teams_api.gemspec
            mkdir -p /tmp/gems
            mv *.gem /tmp/gems/
      - store_artifacts:
          path: /tmp/gems

workflows:
  version: 2
  ci:
    jobs:
      - test
      - lint
      - build_gem:
          requires: [test, lint]
          